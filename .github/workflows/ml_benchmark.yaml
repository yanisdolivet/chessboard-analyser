name: Build and Benchmark ML Models

on:
  push:
    branches: [ "main", "gh-actions" ]
  pull_request:
    branches: [ "main", "gh-actions" ]

env:
  TRAINING_LOSS_FILE: "loss_curve.png"
  TRAINING_METRICS_FILE: "accuracy_curve.png"

permissions:
  contents: write

jobs:
  generate-training-curves:
    runs-on: ubuntu-latest
    name: Generate Training Graphs

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Training Simulation & Plot
      run: python tools/mock_plot_training.py

    - name: Upload Training Curves
      uses: actions/upload-artifact@v4
      with:
        name: training-curves-report
        path: out/curves/*.png
        retention-days: 5

    - name: Publish Results to README
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/gh-actions'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        mkdir -p docs/benchmarks

        cp out/curves/training_metrics.png docs/benchmarks/latest_training_metrics.png

        if ! grep -q "docs/benchmarks/latest_training_metrics.png" README.md; then
          echo "" >> README.md
          echo "## Training Data" >> README.md
          echo "![Latest Training Metrics](docs/benchmarks/latest_training_metrics.png)" >> README.md
        fi

        git add docs/benchmarks/latest_training_metrics.png README.md

        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "docs: update training benchmarks [skip ci]"
          git push
        fi